<section class="dashboard">
  <div class="dashboard-header">
    <div class="header-content">
      <div class="welcome-section">
        <h1>Dashboard</h1>
        <p class="subtitle" *ngIf="user$ | async as user">
          Welcome back, {{ user.company }} · {{ user.role === 'generator' ? 'Seller' : 'Buyer' }}
        </p>
      </div>
      <div class="quick-actions">
        <a 
          *ngIf="isSeller$ | async" 
          routerLink="/listings/create" 
          class="quick-action-btn"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          <span>Create Listing</span>
        </a>
        <a 
          *ngIf="isBuyer$ | async" 
          routerLink="/listings" 
          class="quick-action-btn"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <span>Browse Listings</span>
        </a>
      </div>
    </div>
  </div>

  <div class="kpis-section">
    <ng-container *ngIf="kpis$ | async as kpis; else kpisLoading">
      <app-stat-card
        *ngFor="let stat of kpis"
        [label]="stat.label"
        [value]="stat.value"
        [delta]="stat.delta"
        [positive]="stat.positive"
      />
    </ng-container>
    <ng-template #kpisLoading>
      <app-loading-skeleton type="card" [count]="4" width="250px" height="150px"></app-loading-skeleton>
    </ng-template>
  </div>

  <div class="main-content">
    <!-- Seller Dashboard -->
    <div class="dashboard-content" *ngIf="isSeller$ | async">
      <div class="content-grid">
        <div class="content-card">
          <div class="card-header">
            <h2>My Listings</h2>
            <a routerLink="/listings" class="view-all">View all</a>
          </div>
          <div class="card-content" *ngIf="myListings$ | async as listings">
            <div *ngIf="listings.length === 0" class="empty-state">
              <p>You haven't created any listings yet</p>
              <a routerLink="/listings/create" class="btn-link">Create your first listing</a>
            </div>
            <div class="listing-item" *ngFor="let listing of listings.slice(0, 5)">
              <div class="listing-info">
                <strong>{{ listing.title }}</strong>
                <p>{{ listing.quantityTons }} tons · {{ listing.location }}</p>
                <span class="status-badge" [class]="'status-' + listing.status">{{ listing.status }}</span>
              </div>
              <div class="listing-actions">
                <a [routerLink]="['/listings', listing.id]" class="action-link">View</a>
              </div>
            </div>
          </div>
        </div>

        <div class="content-card">
          <div class="card-header">
            <h2>Bids Received</h2>
            <a routerLink="/bidding" class="view-all">View all</a>
          </div>
          <div class="card-content" *ngIf="bidsReceived$ | async as bids">
            <div *ngIf="bids.length === 0" class="empty-state">
              <p>No bids received yet</p>
            </div>
            <div class="bid-item" *ngFor="let bid of bids.slice(0, 5)">
              <div class="bid-info">
                <strong>{{ bid.bidder }}</strong>
                <p>{{ bid.listingTitle }}</p>
                <span class="bid-amount">{{ bid.amount | currency: 'TND' }}/ton</span>
              </div>
              <span class="bid-status" [class]="'status-' + bid.status">{{ bid.status }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Buyer Dashboard -->
    <div class="dashboard-content" *ngIf="isBuyer$ | async">
      <div class="content-grid">
        <div class="content-card">
          <div class="card-header">
            <h2>Available Listings</h2>
            <a routerLink="/listings" class="view-all">Browse all</a>
          </div>
          <div class="card-content" *ngIf="availableListings$ | async as listings">
            <div *ngIf="listings.length === 0" class="empty-state">
              <p>No listings available</p>
            </div>
            <div class="listing-item" *ngFor="let listing of listings.slice(0, 5)">
              <div class="listing-info">
                <strong>{{ listing.title }}</strong>
                <p>{{ listing.quantityTons }} tons</p>
                <span class="price-badge">{{ listing.pricePerTon | currency: 'TND' }}/ton</span>
              </div>
              <div class="listing-actions">
                <a [routerLink]="['/listings', listing.id]" class="action-link">View Details</a>
                <a routerLink="/bidding" [queryParams]="{listingId: listing.id}" class="action-link primary">Place Bid</a>
              </div>
            </div>
          </div>
        </div>

        <div class="content-card">
          <div class="card-header">
            <h2>My Bids</h2>
            <a routerLink="/bidding" class="view-all">View all</a>
          </div>
          <div class="card-content" *ngIf="myBids$ | async as bids">
            <div *ngIf="bids.length === 0" class="empty-state">
              <p>You haven't placed any bids yet</p>
            </div>
            <div class="bid-item" *ngFor="let bid of bids.slice(0, 5)">
              <div class="bid-info">
                <strong>{{ bid.listingTitle }}</strong>
                <p>{{ bid.amount | currency: 'TND' }}/ton</p>
                <span class="bid-time">{{ bid.timestamp | date: 'short' }}</span>
              </div>
              <span class="bid-status" [class]="'status-' + bid.status">{{ bid.status }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="widget notifications-widget">
        <div class="widget-header">
          <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            Notifications
          </h3>
          <a routerLink="/messaging" class="view-all">View all</a>
        </div>
        <div class="widget-content" *ngIf="notifications$ | async as notifications">
          <div *ngIf="notifications.length === 0" class="empty-state">
            <p>No new notifications</p>
          </div>
          <div class="notification-item" *ngFor="let notification of notifications.slice(0, 5)">
            <div class="notification-dot" [class.unread]="!notification.read"></div>
            <div class="notification-content">
              <strong>{{ notification.title }}</strong>
              <p>{{ notification.detail }}</p>
              <small>{{ notification.timestamp | date: 'short' }}</small>
            </div>
          </div>
        </div>
      </div>

      <div class="widget transactions-widget">
        <div class="widget-header">
          <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="2" x2="12" y2="22"/>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Transactions
          </h3>
          <a routerLink="/transactions" class="view-all">View all</a>
        </div>
        <div class="widget-content" *ngIf="transactions$ | async as transactions">
          <div *ngIf="transactions.length === 0" class="empty-state">
            <p>No active transactions</p>
          </div>
          <div class="transaction-item" *ngFor="let transaction of transactions.slice(0, 5)">
            <div class="transaction-status" [class]="'status-' + transaction.stage.toLowerCase()">
              <span></span>
            </div>
            <div class="transaction-content">
              <strong>{{ transaction.listingTitle }}</strong>
              <p>{{ transaction.counterparty }}</p>
              <small>{{ transaction.stage }}</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
